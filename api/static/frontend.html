<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Nikita DS Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-light: #111827;
      --card: #1f2937;
      --card-light: #243046;
      --accent: #6366f1;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --danger: #f43f5e;
      --success: #22c55e;
      --radius: 14px;
    }
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      /* –û–±—ã—á–Ω–∞—è –¥–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –≤—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à—ë–Ω */
      min-height: 100vh;
      overflow-y: auto;
    }

    header {
      padding: 16px 20px 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .badge {
      background: rgba(99, 102, 241, 0.2);
      color: var(--text);
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    main {
      display: flex;
      gap: 16px;
      padding: 16px 16px 20px;
      /* –í–ê–ñ–ù–û: –ù–ò–ö–ê–ö–ò–• —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—ã—Å–æ—Ç –∏ overflow –∑–¥–µ—Å—å */
    }

    .left-panel {
      width: 260px;
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .middle-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      /* —Ä–∞—Å—Ç—ë—Ç –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É, –±–µ–∑ height */
    }

    .right-panel {
      width: 260px;
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px;
    }

    label {
      font-size: 13px;
      color: var(--text);
      margin-bottom: 4px;
      display: block;
    }
    input[type="file"] {
      width: 100%;
      background: var(--bg-light);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 5px 6px;
      color: var(--text-muted);
      font-size: 13px;
    }
    input[type="text"], textarea {
      width: 100%;
      background: var(--bg-light);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 6px 8px;
      color: var(--text);
      outline: none;
      font-size: 13px;
      resize: vertical;
    }
    input[type="text"]:focus,
    textarea:focus {
      border-color: rgba(99, 102, 241, 0.9);
    }
    button {
      background: var(--accent);
      border: none;
      color: white;
      padding: 8px 0;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.15s;
      font-size: 13px;
    }
    button:disabled {
      background: rgba(99, 102, 241, 0.3);
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      filter: brightness(1.05);
    }

    .status-ok {
      font-size: 12px;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .status-err {
      font-size: 12px;
      color: var(--danger);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .report-box {
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px 16px;
      min-height: 180px;
      white-space: pre-wrap;
      overflow-y: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
    }

    .recs-box {
      background: rgba(15, 23, 42, 0.3);
      border: 1px solid rgba(148, 163, 184, 0.06);
      border-radius: var(--radius);
      padding: 10px 14px 12px;
      min-height: 56px;
      max-height: 140px;
      overflow-y: auto;
      font-size: 12px;
    }
    .recs-box h4 {
      margin: 0 0 6px;
      font-size: 12px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .recs-box ul {
      margin: 0;
      padding-left: 16px;
    }
    .recs-box li {
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    .plots-row {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      padding-bottom: 24px;   /* –º–µ—Å—Ç–æ –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–∏ + —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
      overflow-x: auto;       /* –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –º–Ω–æ–≥–æ */
      /* –ù–ò–ö–ê–ö–ò–• height/overflow-y: –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ –ø–æ–ª–Ω–æ–π –≤—ã—Å–æ—Ç–µ */
    }

    .plot-card {
      background: var(--card);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.05);
      min-width: 230px;
      max-width: 260px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .plot-card img {
      width: 100%;
      height: auto;           /* –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é */
      display: block;
    }
    .plot-title {
      font-size: 12px;
      padding: 6px 8px 8px;
      color: var(--text-muted);
    }

    .runs-title {
      font-size: 13px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .run-item {
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(148, 163, 184, 0.05);
      border-radius: 10px;
      padding: 6px 8px;
      margin-bottom: 6px;
      cursor: pointer;
    }
    .run-item.active {
      border-color: rgba(99, 102, 241, 0.8);
      background: rgba(99, 102, 241, 0.15);
    }
    .run-item small {
      display: block;
      color: var(--text-muted);
      font-size: 11px;
    }
    .runs-empty {
      font-size: 12px;
      color: var(--text-muted);
    }

    .agent-panel {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px solid rgba(148,163,184,0.15);
    }
    .agent-answer {
      margin-top: 8px;
      font-size: 12px;
      white-space: pre-wrap;
      background: rgba(15,23,42,0.4);
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(148,163,184,0.08);
      max-height: 220px;
      overflow-y: auto;
    }
    .agent-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    details summary {
      cursor: pointer;
      user-select: none;
    }
    pre {
      background: rgba(17, 24, 39, 0.85);
      border: 1px solid rgba(148,163,184,0.08);
      border-radius: 10px;
      padding: 10px 12px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.45;
      margin: 6px 0 0;
    }

    .fi-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .fi-name {
      flex: 0 0 90px;
      font-size: 11px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .fi-bar-wrapper {
      flex: 1;
      background: rgba(15,23,42,0.6);
      border-radius: 999px;
      overflow: hidden;
      height: 6px;
    }
    .fi-bar {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #22c55e);
      border-radius: 999px;
      transform-origin: left;
      transition: width 0.3s ease-out;
    }
    .fi-val {
      flex: 0 0 40px;
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
    }

    @media (max-width: 1100px) {
      main { flex-direction: column; }
      .left-panel, .right-panel { width: 100%; }
      .plots-row { margin-top: 8px; }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; gap:8px; align-items:center;">
      <h1 style="font-size: 18px; font-weight: 600; margin:0;">Nikita DS Agent</h1>
      <span class="badge">beta</span>
    </div>
    <small style="color:var(--text-muted); font-size:12px;">CSV/Excel/JSON ‚Üí EDA ‚Üí baseline ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–æ–≤ ‚Üí –≤–æ–ø—Ä–æ—Å—ã –∫ –∞–≥–µ–Ω—Ç—É</small>
  </header>

  <main>
    <!-- –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <section class="left-panel">
      <h2 style="font-size:14px; margin:0 0 4px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞</h2>
      <p style="font-size:12px; color:var(--text-muted); margin:0 0 8px;">–§–∞–π–ª —Å —Ç–∞–±–ª–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ + (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∏–º—è —Ç–∞—Ä–≥–µ—Ç–∞.</p>

      <label for="file">–§–∞–π–ª (CSV / Excel / JSON / Parquet)</label>
      <input id="file" type="file" />

      <label for="target">Target (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input id="target" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, price –∏–ª–∏ label" />

      <button id="uploadBtn" onclick="uploadDataset()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <div id="status" style="min-height:22px; margin-top:4px; font-size:12px;"></div>
      <small style="font-size:11px; color:var(--text-muted);">–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ <code>/upload</code>, –±—ç–∫–µ–Ω–¥ –¥–µ–ª–∞–µ—Ç EDA –∏ –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å.</small>

      <hr style="border:0; border-top:1px solid rgba(148,163,184,0.18); margin:10px 0 8px;">

      <h3 style="font-size:13px; margin:0 0 4px;">–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ø–æ –º–æ–¥–µ–ª–∏</h3>
      <p style="font-size:11px; color:var(--text-muted); margin:0 0 6px;">
        1) –í—ã–±–µ—Ä–∏ run —Å–ø—Ä–∞–≤–∞ –≤ —Å–ø–∏—Å–∫–µ.<br>
        2) –ó–∞–≥—Ä—É–∑–∏—Å—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –¥–ª—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞.
      </p>

      <label for="predictFile">–§–∞–π–ª –¥–ª—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞</label>
      <input id="predictFile" type="file" />

      <label for="predictRows">–°–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –≤ –ø—Ä–µ–≤—å—é</label>
      <input id="predictRows" type="text" value="30" />

      <button id="predictBtn" onclick="predictOnRun()">–°–¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è</button>
      <div id="predictStatus" style="min-height:18px; margin-top:4px; font-size:11px;"></div>
    </section>

    <!-- —Ü–µ–Ω—Ç—Ä -->
    <section class="middle-panel">
      <div class="report-box" id="reportBox">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç—á—ë—Ç ‚ú®</div>

      <div class="recs-box" id="modelCardBox"></div>
      <div class="recs-box" id="metricsBox"></div>
      <div class="recs-box" id="healthBox"></div>
      <div class="recs-box" id="recs"></div>
      <div class="recs-box" id="mlHints"></div>
      <div class="recs-box" id="planBox"></div>
      <div class="recs-box" id="predictBox"></div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä—è–¥, –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–µ–∂–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ -->
      <div class="plots-row" id="plotsRow"></div>
    </section>

    <!-- —Å–ø—Ä–∞–≤–∞ -->
    <aside class="right-panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="runs-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏</div>
        <button style="width:auto; padding:3px 8px; font-size:11px;" onclick="loadRuns()">‚Üª</button>
      </div>
      <div id="runsList" style="min-height:60px;"></div>

      <div class="agent-panel">
        <div class="runs-title" style="margin-bottom:4px;">–°–ø—Ä–æ—Å–∏—Ç—å DS-–∞–≥–µ–Ω—Ç–∞</div>
        <div class="agent-hint">
          –ù–∞–ø—Ä–∏–º–µ—Ä: <em>–ß—Ç–æ –º–Ω–µ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏?</em>
        </div>
        <textarea id="agentQuestion" rows="3" placeholder="–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–∫—É—â–µ–º—É run_id..."></textarea>
        <button style="margin-top:6px;" onclick="askAgent()">–°–ø—Ä–æ—Å–∏—Ç—å</button>
        <div id="agentAnswer" class="agent-answer" style="margin-top:8px;"></div>
      </div>
    </aside>
  </main>

  <script>
    const reportBox     = document.getElementById('reportBox');
    const plotsRow      = document.getElementById('plotsRow');
    const statusEl      = document.getElementById('status');
    const runsList      = document.getElementById('runsList');
    const uploadBtn     = document.getElementById('uploadBtn');
    const recsBox       = document.getElementById('recs');
    const mlHintsBox    = document.getElementById('mlHints');
    const healthBox     = document.getElementById('healthBox');
    const planBox       = document.getElementById('planBox');
    const metricsBox    = document.getElementById('metricsBox');
    const modelCardBox  = document.getElementById('modelCardBox');
    const agentQuestion = document.getElementById('agentQuestion');
    const agentAnswer   = document.getElementById('agentAnswer');

    const predictBox    = document.getElementById('predictBox');
    const predictStatus = document.getElementById('predictStatus');
    const predictBtn    = document.getElementById('predictBtn');

    let currentRunId = null;

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    async function uploadDataset() {
      const fileInput  = document.getElementById('file');
      const targetInput= document.getElementById('target');
      const file       = fileInput.files[0];

      if (!file) {
        statusEl.innerHTML = '<span class="status-err">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏</span>';
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('target', targetInput.value || '');

      uploadBtn.disabled = true;
      statusEl.innerHTML = '<span style="font-size:12px; color:var(--text-muted);">–ó–∞–≥—Ä—É–∂–∞–µ–º –∏ —Å—á–∏—Ç–∞–µ–º EDA...</span>';

      try {
        const resp = await fetch('/upload', { method: 'POST', body: formData });
        const data = await resp.json();

        if (!resp.ok) {
          const msg = data.detail?.details || data.detail || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
          statusEl.innerHTML = '<div class="status-err">–û—à–∏–±–∫–∞: ' + escapeHtml(msg) + '</div>';
          uploadBtn.disabled = false;
          return;
        }

        statusEl.innerHTML = '<span class="status-ok">–ì–æ—Ç–æ–≤–æ ‚úÖ run_id: ' + data.run_id + '</span>';
        currentRunId = data.run_id;

        renderReport(data);
        renderModelCard(data);
        renderMetrics(data);
        renderHealth(data);
        renderRecommendations(data);
        renderMLHints(data);
        renderExperimentPlan(data);
        renderPredictResult(null);
        renderPlots(data);
        loadRuns();

      } catch (err) {
        console.error(err);
        statusEl.innerHTML = '<div class="status-err">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
      } finally {
        uploadBtn.disabled = false;
      }
    }

    function renderReport(data) {
      if (data.report) {
        reportBox.textContent = data.report;
        return;
      }
      let txt = 'üìÅ ' + (data.filename || '') + '\n';
      if (data.eda?.shape) {
        txt += `üìä ${data.eda.shape[0]} —Å—Ç—Ä–æ–∫ x ${data.eda.shape[1]} –∫–æ–ª–æ–Ω–æ–∫\n`;
      }
      if (data.task?.task) {
        txt += `üß† –ó–∞–¥–∞—á–∞: ${data.task.task} ${data.task.target ? '–ø–æ ' + data.task.target : ''}\n`;
      }
      if (data.model) {
        txt += `üß™ –ú–æ–¥–µ–ª—å: ${data.model.model_type}`;
        if (data.model.accuracy != null) txt += `, acc=${data.model.accuracy.toFixed(3)}`;
        if (data.model.f1 != null)       txt += `, f1=${data.model.f1.toFixed(3)}`;
        if (data.model.roc_auc != null)  txt += `, roc_auc=${data.model.roc_auc.toFixed(3)}`;
        if (data.model.pr_auc  != null)  txt += `, pr_auc=${data.model.pr_auc.toFixed(3)}`;
        if (data.model.rmse != null)     txt += `, rmse=${data.model.rmse.toFixed(3)}`;
      }
      reportBox.textContent = txt;
    }

    function renderModelCard(data) {
      modelCardBox.innerHTML = '';

      const model = data.model;
      const task  = data.task || {};
      if (!model) {
        modelCardBox.innerHTML = '<span style="color:var(--text-muted);">–ú–æ–¥–µ–ª—å –µ—â—ë –Ω–µ –æ–±—É—á–µ–Ω–∞ ‚Äî —Å–µ–π—á–∞—Å —Ç–æ–ª—å–∫–æ EDA.</span>';
        return;
      }

      const taskType = task.task || '‚Äî';
      const target   = task.target || model.target || '‚Äî';
      const algo     = model.model_type || '–º–æ–¥–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
      const lib      = model.library || model.framework || '';
      const nRows    = model.n_train_rows ?? (data.eda?.shape ? data.eda.shape[0] : null);
      const nFeatures= model.n_features   ?? (data.eda?.shape ? data.eda.shape[1] : null);
      const cv       = model.cv_folds || model.cv || null;
      const isBaseline = model.is_baseline;

      function pickMainMetric() {
        if (taskType === 'classification') {
          if (model.f1 != null)      return { name: 'F1', value: model.f1 };
          if (model.roc_auc != null) return { name: 'ROC-AUC', value: model.roc_auc };
          if (model.accuracy != null)return { name: 'Accuracy', value: model.accuracy };
        } else if (taskType === 'regression') {
          if (model.rmse != null) return { name: 'RMSE', value: model.rmse };
          if (model.mae  != null) return { name: 'MAE',  value: model.mae };
          if (model.r2   != null) return { name: 'R¬≤',   value: model.r2 };
        }
        return null;
      }

      const mainMetric = pickMainMetric();
      const fmt = (v) => (typeof v === 'number' ? v.toFixed(3) : v);

      let html = '<h4>Model card</h4>';
      html += `<div style="font-size:12px; margin-bottom:4px;"><strong>${escapeHtml(algo)}</strong>${lib ? ' ¬∑ ' + escapeHtml(lib) : ''}</div>`;
      html += '<ul style="margin:0; padding-left:16px; font-size:12px;">';
      html += `<li>–ó–∞–¥–∞—á–∞: ${escapeHtml(taskType)} –ø–æ <code>${escapeHtml(target)}</code></li>`;
      if (nRows != null && nFeatures != null) {
        html += `<li>–û–±—É—á–µ–Ω–∏–µ –Ω–∞ ~${escapeHtml(String(nRows))} —Å—Ç—Ä–æ–∫ √ó ${escapeHtml(String(nFeatures))} —Ñ–∏—á.</li>`;
      } else if (nRows != null) {
        html += `<li>–û–±—É—á–µ–Ω–∏–µ –Ω–∞ ~${escapeHtml(String(nRows))} —Å—Ç—Ä–æ–∫.</li>`;
      }
      if (cv) {
        html += `<li>–í–∞–ª–∏–¥–∞—Ü–∏—è: cross-validation (${escapeHtml(String(cv))} folds).</li>`;
      }
      if (mainMetric) {
        html += `<li>–ö–ª—é—á–µ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞: <strong>${escapeHtml(mainMetric.name)}</strong> = ${fmt(mainMetric.value)}</li>`;
      }
      if (isBaseline) {
        html += '<li>–†–µ–∂–∏–º: baseline-–º–æ–¥–µ–ª—å (—Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞).</li>';
      }
      html += '</ul>';

      modelCardBox.innerHTML = html;
    }

    function renderMetrics(data) {
      metricsBox.innerHTML = '';

      const model = data.model;
      if (!model) {
        metricsBox.innerHTML = '<span style="color:var(--text-muted);">–ú–æ–¥–µ–ª—å –µ—â—ë –Ω–µ –æ–±—É—á–µ–Ω–∞ –∏–ª–∏ –∑–∞–¥–∞—á–∞ = —Ç–æ–ª—å–∫–æ EDA.</span>';
        return;
      }

      const taskType = (data.task && data.task.task) || '';
      const fmt = (v) =>
        (typeof v === 'number'
          ? v.toFixed(3)
          : (v === null || v === undefined ? '‚Äî' : String(v)));

      let html = '<h4>–ú–µ—Ç—Ä–∏–∫–∏ –º–æ–¥–µ–ª–∏</h4>';

      if (taskType === 'classification') {
        html += '<ul>';
        if (model.accuracy != null)
          html += `<li><strong>Accuracy</strong>: ${fmt(model.accuracy)} ‚Äî –¥–æ–ª—è –≤–µ—Ä–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π.</li>`;
        if (model.precision != null)
          html += `<li><strong>Precision</strong>: ${fmt(model.precision)} ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —á–∏—Å—Ç—ã –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è.</li>`;
        if (model.recall != null)
          html += `<li><strong>Recall</strong>: ${fmt(model.recall)} ‚Äî –∫–∞–∫ —Ö–æ—Ä–æ—à–æ –Ω–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã.</li>`;
        if (model.f1 != null)
          html += `<li><strong>F1</strong>: ${fmt(model.f1)} ‚Äî –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É precision –∏ recall.</li>`;
        if (model.roc_auc != null)
          html += `<li><strong>ROC-AUC</strong>: ${fmt(model.roc_auc)} ‚Äî –≤–∞–∂–Ω–æ –ø—Ä–∏ –¥–∏—Å–±–∞–ª–∞–Ω—Å–µ –∫–ª–∞—Å—Å–æ–≤.</li>`;
        if (model.pr_auc != null)
          html += `<li><strong>PR-AUC</strong>: ${fmt(model.pr_auc)} ‚Äî –µ—â—ë –æ–¥–∏–Ω –≤–∞–∂–Ω—ã–π —Å–∫–æ—Ä –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º –¥–∏—Å–±–∞–ª–∞–Ω—Å–µ.</li>`;
        html += '</ul>';
      } else if (taskType === 'regression') {
        html += '<ul>';
        if (model.mae != null)
          html += `<li><strong>MAE</strong>: ${fmt(model.mae)} ‚Äî —Å—Ä–µ–¥–Ω—è—è –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.</li>`;
        if (model.rmse != null)
          html += `<li><strong>RMSE</strong>: ${fmt(model.rmse)} ‚Äî —à—Ç—Ä–∞—Ñ—É–µ—Ç –∑–∞ –±–æ–ª—å—à–∏–µ –æ—à–∏–±–∫–∏.</li>`;
        if (model.r2 != null)
          html += `<li><strong>R¬≤</strong>: ${fmt(model.r2)} ‚Äî –¥–æ–ª—è –æ–±—ä—è—Å–Ω—ë–Ω–Ω–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏ —Ç–∞—Ä–≥–µ—Ç–∞.</li>`;
        if (model.mape != null)
          html += `<li><strong>MAPE</strong>: ${fmt(model.mape)} ‚Äî —Å—Ä–µ–¥–Ω—è—è –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.</li>`;
        html += '</ul>';
      } else {
        html += '<span style="color:var(--text-muted);">–¢–∏–ø –∑–∞–¥–∞—á–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –Ω–æ —á–∞—Å—Ç—å –º–µ—Ç—Ä–∏–∫ –¥–æ—Å—Ç—É–ø–Ω–∞.</span>';
      }

      if (Array.isArray(model.confusion_matrix)) {
        html += `
          <div style="margin-top:6px; font-size:11px; color:var(--text-muted);">
            Confusion matrix (–∫–∞–∫ –µ—Å—Ç—å, –ø–æ –∫–ª–∞—Å—Å–∞–º):
          </div>
          <pre><code>${escapeHtml(JSON.stringify(model.confusion_matrix))}</code></pre>
        `;
      }

      metricsBox.innerHTML = html;
    }

    function renderHealth(data) {
      const health = data.dataset_health;
      if (!health) {
        healthBox.innerHTML = '<span style="color:var(--text-muted);">–û—Ü–µ–Ω–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –¥–∞—Ç–∞—Å–µ—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.</span>';
        return;
      }
      const levelMap = { green: '–∑–µ–ª—ë–Ω—ã–π', yellow: '–∂—ë–ª—Ç—ã–π', red: '–∫—Ä–∞—Å–Ω—ã–π' };
      const colorMap = { green: '#22c55e', yellow: '#eab308', red: '#f97316' };
      const level = health.level || 'yellow';
      const score = health.score ?? '?';
      const reasons = health.reasons || [];

      let html = '<h4>–û—Ü–µ–Ω–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –¥–∞—Ç–∞—Å–µ—Ç–∞</h4>';
      html += `<div style="font-size:12px; margin-bottom:4px;">
        <span style="font-weight:600; color:${colorMap[level] || 'var(--accent)'};">
          ${score}/100 ¬∑ ${levelMap[level] || level}
        </span>
      </div>`;
      if (reasons.length) {
        html += '<ul>' + reasons.map(r => `<li>${escapeHtml(r)}</li>`).join('') + '</ul>';
      } else {
        html += '<span style="color:var(--text-muted);">–°–µ—Ä—å—ë–∑–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</span>';
      }
      healthBox.innerHTML = html;
    }

    function renderRecommendations(data) {
      recsBox.innerHTML = '';
      const recs = data.recommendations;
      if (!recs || !Array.isArray(recs) || recs.length === 0) {
        recsBox.innerHTML = '<span style="color:var(--text-muted);">–ü–æ–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–µ—Ç.</span>';
        return;
      }
      const h = document.createElement('h4');
      h.innerHTML = '–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:';
      const ul = document.createElement('ul');
      recs.forEach((r) => {
        const li = document.createElement('li');
        li.textContent = r;
        ul.appendChild(li);
      });
      recsBox.appendChild(h);
      recsBox.appendChild(ul);
    }

    function renderMLHints(data) {
      mlHintsBox.innerHTML = '';
      const parts = [];

      if (Array.isArray(data.feature_importance) && data.feature_importance.length > 0) {
        const top = data.feature_importance
          .slice()
          .sort((a, b) => (b.importance || 0) - (a.importance || 0))
          .slice(0, 5);

        const maxImp = top.reduce((m, fi) => {
          const v = typeof fi.importance === 'number'
            ? fi.importance
            : parseFloat(fi.importance) || 0;
          return v > m ? v : m;
        }, 0) || 1;

        let html = '<div style="margin-bottom:4px;"><strong>–¢–æ–ø —Ñ–∏—á –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏:</strong></div>';
        top.forEach(fi => {
          const raw = typeof fi.importance === 'number'
            ? fi.importance
            : parseFloat(fi.importance) || 0;
          const widthPct = Math.max(4, (raw / maxImp) * 100);
          const label = typeof fi.importance === 'number'
            ? fi.importance.toFixed(3)
            : String(fi.importance);
          html += `
            <div class="fi-row">
              <span class="fi-name" title="${escapeHtml(fi.feature)}">${escapeHtml(fi.feature)}</span>
              <div class="fi-bar-wrapper">
                <div class="fi-bar" style="width:${widthPct}%;"></div>
              </div>
              <span class="fi-val">${escapeHtml(label)}</span>
            </div>
          `;
        });
        parts.push(html);
      }

      if (Array.isArray(data.feature_suggestions) && data.feature_suggestions.length > 0) {
        let html = '<div style="margin-bottom:4px;"><strong>–ò–¥–µ–∏ –Ω–æ–≤—ã—Ö —Ñ–∏—á:</strong></div><ul>';
        data.feature_suggestions.slice(0, 5).forEach(s => {
          html += `<li>${escapeHtml(s)}</li>`;
        });
        html += '</ul>';
        parts.push(html);
      }

      if (Array.isArray(data.code_hints) && data.code_hints.length > 0) {
        let html = '<div style="margin-bottom:4px;"><strong>–ö–æ–¥ / –ø—Ä–∏—ë–º—ã:</strong></div><ul>';
        data.code_hints.slice(0, 5).forEach(hint => {
          if (typeof hint === 'string') {
            html += `<li>${escapeHtml(hint)}</li>`;
          } else if (hint && typeof hint === 'object') {
            const title = hint.title || hint.name || 'snippet';
            const code  = hint.code || hint.snippet || hint.text || '';
            html += `<li>
              <details>
                <summary>${escapeHtml(title)}</summary>
                ${code ? `<pre><code>${escapeHtml(code)}</code></pre>` : ''}
              </details>
            </li>`;
          } else {
            html += `<li>${escapeHtml(String(hint))}</li>`;
          }
        });
        html += '</ul>';
        parts.push(html);
      }

      mlHintsBox.innerHTML = parts.length
        ? parts.join('<hr style="border:0; border-top:1px solid rgba(148,163,184,0.05); margin:6px 0;">')
        : '<span style="color:var(--text-muted);">–ü–æ–∫–∞ –Ω–µ—á–µ–≥–æ –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –ø–æ —Ñ–∏—á–∞–º/–∫–æ–¥—É.</span>';
    }

    function renderExperimentPlan(data) {
      const plan = data.experiment_plan;
      planBox.innerHTML = '';
      if (!Array.isArray(plan) || plan.length === 0) {
        planBox.innerHTML = '<span style="color:var(--text-muted);">–ü–ª–∞–Ω —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –µ—â—ë –Ω–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω.</span>';
        return;
      }

      const groups = { now: [], next: [], later: [] };
      plan.forEach(step => {
        const p = step.priority || 'next';
        (groups[p] || groups.next).push(step);
      });

      let html = '<h4>–ü–ª–∞–Ω —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤</h4>';

      function block(title, key, emoji) {
        const arr = groups[key];
        if (!arr || arr.length === 0) return '';
        let out = `<div style="margin-top:4px; margin-bottom:2px; font-size:12px; font-weight:600;">${emoji} ${title}</div><ul>`;
        arr.slice(0, 5).forEach(step => {
          out += `<li><strong>${escapeHtml(step.title || '')}</strong>: ${escapeHtml(step.description || '')}</li>`;
        });
        out += '</ul>';
        return out;
      }

      html += block('–°–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å', 'now', 'üî•');
      html += block('–î–∞–ª—å—à–µ', 'next', '‚û°Ô∏è');
      html += block('–ü–æ—Ç–æ–º', 'later', 'üïí');

      planBox.innerHTML = html;
    }

    function renderPredictResult(data) {
      if (!predictBox) return;

      if (!data) {
        predictBox.innerHTML = '<span style="color:var(--text-muted);">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.</span>';
        return;
      }

      const fmt = (v) =>
        (typeof v === 'number'
          ? v.toFixed(3)
          : (v === null || v === undefined ? '‚Äî' : String(v)));

      let html = '<h4>–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ø–æ –Ω–æ–≤–æ–º—É —Ñ–∞–π–ª—É</h4>';
      html += `<div style="font-size:12px; margin-bottom:4px;">–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: ${data.n_rows ?? '?'}</div>`;

      if (data.metrics) {
        html += '<div style="font-size:12px; margin-bottom:4px;">–ö–∞—á–µ—Å—Ç–≤–æ –Ω–∞ —ç—Ç–æ–º —Ñ–∞–π–ª–µ:</div><ul>';
        const m = data.metrics;
        if (m.accuracy  != null) html += `<li><strong>Accuracy</strong>: ${fmt(m.accuracy)}</li>`;
        if (m.f1_macro  != null) html += `<li><strong>F1-macro</strong>: ${fmt(m.f1_macro)}</li>`;
        if (m.rmse      != null) html += `<li><strong>RMSE</strong>: ${fmt(m.rmse)}</li>`;
        if (m.mae       != null) html += `<li><strong>MAE</strong>: ${fmt(m.mae)}</li>`;
        if (m.r2        != null) html += `<li><strong>R¬≤</strong>: ${fmt(m.r2)}</li>`;
        html += '</ul>';
      }

      const preview = Array.isArray(data.preview) ? data.preview : [];
      if (preview.length) {
        const cols = Object.keys(preview[0]);

        html += '<div style="margin-top:4px; max-height:170px; overflow:auto;">';
        html += '<table style="width:100%; border-collapse:collapse; font-size:11px;">';
        html += '<thead><tr>';
        cols.forEach(c => {
          html += `<th style="position:sticky; top:0; background:rgba(15,23,42,0.95); text-align:left; padding:3px 4px; border-bottom:1px solid rgba(148,163,184,0.2);">${escapeHtml(c)}</th>`;
        });
        html += '</tr></thead><tbody>';

        preview.forEach(row => {
          html += '<tr>';
          cols.forEach(c => {
            html += `<td style="padding:2px 4px; border-bottom:1px solid rgba(148,163,184,0.08);">${escapeHtml(row[c])}</td>`;
          });
          html += '</tr>';
        });

        html += '</tbody></table></div>';
      } else {
        html += '<span style="color:var(--text-muted);">–ü—Ä–µ–≤—å—é –ø—É—Å—Ç–æ–µ.</span>';
      }

      predictBox.innerHTML = html;
    }

    function renderPlots(data) {
      plotsRow.innerHTML = '';
      if (!data.plots || !Array.isArray(data.plots) || data.plots.length === 0) return;
      data.plots.forEach(p => {
        const card = document.createElement('div');
        card.className = 'plot-card';
        const img = document.createElement('img');
        img.src = 'data:image/png;base64,' + p.image_base64;
        const title = document.createElement('div');
        title.className = 'plot-title';
        title.textContent = p.name;
        card.appendChild(img);
        card.appendChild(title);
        plotsRow.appendChild(card);
      });
    }

    async function predictOnRun() {
      const fileInput  = document.getElementById('predictFile');
      const rowsInput  = document.getElementById('predictRows');
      const file       = fileInput?.files?.[0];

      if (!currentRunId) {
        predictStatus.innerHTML = '<span class="status-err">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ run —Å–ø—Ä–∞–≤–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ –¥–∞—Ç–∞—Å–µ—Ç.</span>';
        return;
      }
      if (!file) {
        predictStatus.innerHTML = '<span class="status-err">–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª –¥–ª—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞.</span>';
        return;
      }

      let rows = parseInt((rowsInput?.value || '30'), 10);
      if (Number.isNaN(rows) || rows <= 0) rows = 30;

      const formData = new FormData();
      formData.append('file', file);
      formData.append('include_proba', 'true');
      formData.append('return_rows', String(rows));

      if (predictBtn) predictBtn.disabled = true;
      predictStatus.innerHTML = '<span style="font-size:11px; color:var(--text-muted);">–°—á–∏—Ç–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è...</span>';

      try {
        const resp = await fetch(`/runs/${encodeURIComponent(currentRunId)}/predict`, {
          method: 'POST',
          body: formData,
        });
        const data = await resp.json();

        if (!resp.ok) {
          const detail = data.detail || data.error || data;
          const msg = typeof detail === 'string'
            ? detail
            : (detail.details || JSON.stringify(detail));
          predictStatus.innerHTML = '<span class="status-err">–û—à–∏–±–∫–∞: ' + escapeHtml(msg) + '</span>';
          return;
        }

        renderPredictResult(data);
        predictStatus.innerHTML = '<span class="status-ok">–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã ‚úÖ</span>';
      } catch (e) {
        console.error(e);
        predictStatus.innerHTML = '<span class="status-err">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ /predict.</span>';
      } finally {
        if (predictBtn) predictBtn.disabled = false;
      }
    }

    async function loadRuns() {
      try {
        const resp = await fetch('/runs');
        if (!resp.ok) return;
        const arr = await resp.json();
        runsList.innerHTML = '';
        if (!arr.length) {
          runsList.innerHTML = '<div class="runs-empty">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø—É—Å–∫–æ–≤</div>';
          return;
        }
        arr.forEach(run => {
          const div = document.createElement('div');
          div.className = 'run-item' + (run.run_id === currentRunId ? ' active' : '');
          div.onclick = () => selectRun(run.run_id);
          div.innerHTML = `
            <div style="font-size:12px;">${escapeHtml(run.filename || '(–±–µ–∑ –∏–º–µ–Ω–∏)')}</div>
            <small>${escapeHtml(run.run_id)}</small>
            <small>${run.task ? escapeHtml(run.task.task + (run.task.target ? ' ¬∑ ' + run.task.target : '')) : ''}</small>
          `;
          runsList.appendChild(div);
        });
      } catch (e) {
        console.warn('cannot load runs', e);
      }
    }

    async function selectRun(runId) {
      try {
        const resp = await fetch('/runs/' + runId);
        if (!resp.ok) return;
        const data = await resp.json();
        currentRunId = runId;

        renderReport(data);
        renderModelCard(data);
        renderMetrics(data);
        renderHealth(data);
        renderRecommendations(data);
        renderMLHints(data);
        renderExperimentPlan(data);
        renderPredictResult(null);
        renderPlots(data);

        Array.from(runsList.children).forEach(ch => {
          ch.classList.toggle('active', ch.textContent.includes(runId));
        });
      } catch (e) {
        console.warn('cannot load run', e);
      }
    }

    async function askAgent() {
      const q = (agentQuestion.value || '').trim();
      if (!currentRunId) {
        agentAnswer.textContent = '–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ (–∑–∞–≥—Ä—É–∑–∏ –¥–∞—Ç–∞—Å–µ—Ç), —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª—Å—è run_id.';
        return;
      }
      if (!q) {
        agentAnswer.textContent = '–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –¥–ª—è –∞–≥–µ–Ω—Ç–∞.';
        return;
      }

      const formData = new FormData();
      formData.append('run_id', currentRunId);
      formData.append('question', q);

      agentAnswer.textContent = '–î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º...';

      try {
        const resp = await fetch('/ask', { method: 'POST', body: formData });
        const data = await resp.json();
        if (!resp.ok) {
          const msg = data.detail || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ /ask';
          agentAnswer.textContent = '–û—à–∏–±–∫–∞: ' + (typeof msg === 'string' ? msg : JSON.stringify(msg));
          return;
        }
        agentAnswer.textContent = data.answer || '(–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)';
      } catch (e) {
        console.error(e);
        agentAnswer.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ /ask.';
      }
    }

    loadRuns();
  </script>
</body>
</html>
