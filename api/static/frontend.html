<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Nikita DS Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-light: #111827;
      --card: #1f2937;
      --card-light: #243046;
      --accent: #6366f1;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --danger: #f43f5e;
      --success: #22c55e;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 16px 20px 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .badge {
      background: rgba(99, 102, 241, 0.2);
      color: var(--text);
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 12px;
    }
    main {
      flex: 1;
      display: flex;
      gap: 16px;
      padding: 16px 16px 20px;
      overflow: hidden;
    }
    .left-panel {
      width: 260px;
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      height: calc(100vh - 90px);
    }
    .middle-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: calc(100vh - 90px);
    }
    .right-panel {
      width: 240px;
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px;
      height: calc(100vh - 90px);
      overflow-y: auto;
    }
    label {
      font-size: 13px;
      color: var(--text);
      margin-bottom: 4px;
      display: block;
    }
    input[type="file"] {
      width: 100%;
      background: var(--bg-light);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 5px 6px;
      color: var(--text-muted);
      font-size: 13px;
    }
    input[type="text"] {
      width: 100%;
      background: var(--bg-light);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 6px 8px;
      color: var(--text);
      outline: none;
      font-size: 13px;
    }
    input[type="text"]:focus {
      border-color: rgba(99, 102, 241, 0.8);
    }
    textarea {
      width: 100%;
      background: var(--bg-light);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 6px 8px;
      color: var(--text);
      outline: none;
      font-size: 12px;
      resize: vertical;
      min-height: 70px;
    }
    textarea:focus {
      border-color: rgba(99, 102, 241, 0.8);
    }
    button {
      background: var(--accent);
      border: none;
      color: white;
      padding: 8px 0;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.15s;
      font-size: 13px;
    }
    button:disabled {
      background: rgba(99, 102, 241, 0.3);
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      filter: brightness(1.02);
    }
    .status-ok {
      font-size: 12px;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .status-err {
      font-size: 12px;
      color: var(--danger);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .report-box {
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px 16px;
      height: 38%;
      min-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .recs-box {
      background: rgba(15, 23, 42, 0.3);
      border: 1px solid rgba(148, 163, 184, 0.03);
      border-radius: var(--radius);
      padding: 10px 14px 12px;
      min-height: 60px;
      max-height: 110px;
      overflow-y: auto;
      font-size: 12px;
    }
    .recs-box h4 {
      margin: 0 0 6px;
      font-size: 12px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .recs-box ul {
      margin: 0;
      padding-left: 16px;
    }
    .recs-box li {
      margin-bottom: 4px;
      color: var(--text-muted);
    }
    .plots-row {
      display: flex;
      gap: 16px;
      height: 40%;
      overflow-x: auto;
    }
    .plot-card {
      background: var(--card);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.05);
      min-width: 220px;
      max-width: 240px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .plot-card img {
      width: 100%;
      display: block;
    }
    .plot-title {
      font-size: 12px;
      padding: 6px 8px 8px;
      color: var(--text-muted);
    }
    .runs-title {
      font-size: 13px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .run-item {
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(148, 163, 184, 0.03);
      border-radius: 10px;
      padding: 6px 8px;
      margin-bottom: 6px;
      cursor: pointer;
    }
    .run-item.active {
      border-color: rgba(99, 102, 241, 0.6);
      background: rgba(99, 102, 241, 0.1);
    }
    .run-item small {
      display: block;
      color: var(--text-muted);
      font-size: 11px;
    }
    .runs-empty {
      font-size: 12px;
      color: var(--text-muted);
    }

    .agent-answer {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
      white-space: pre-wrap;
    }

    /* —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–¥–∞ */
    details summary {
      cursor: pointer;
      user-select: none;
    }
    pre {
      background: rgba(17, 24, 39, 0.85);
      border: 1px solid rgba(148,163,184,0.08);
      border-radius: 10px;
      padding: 10px 12px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.45;
      margin: 6px 0 0;
    }

    @media (max-width: 1100px) {
      main { flex-direction: column; }
      .left-panel, .right-panel { width: 100%; height: auto; }
      .middle-panel { height: auto; }
      .plots-row { height: auto; }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; gap:8px; align-items:center;">
      <h1 style="font-size: 18px; font-weight: 600; margin:0;">Nikita DS Agent</h1>
      <span class="badge">beta</span>
    </div>
    <small style="color:var(--text-muted); font-size:12px;">
      CSV ‚Üí EDA ‚Üí baseline ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–æ–≤ ‚Üí –≤–æ–ø—Ä–æ—Å—ã –∫ –∞–≥–µ–Ω—Ç—É
    </small>
  </header>

  <main>
    <!-- –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –∑–∞–≥—Ä—É–∑–∫–∞ -->
    <section class="left-panel">
      <h2 style="font-size:14px; margin:0 0 4px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞</h2>
      <p style="font-size:12px; color:var(--text-muted); margin:0 0 8px;">CSV-—Ñ–∞–π–ª + (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∏–º—è target.</p>

      <label for="file">CSV —Ñ–∞–π–ª</label>
      <input id="file" type="file" accept=".csv" />

      <label for="target">Target (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input id="target" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, price –∏–ª–∏ label" />

      <button id="uploadBtn" onclick="uploadDataset()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <div id="status" style="min-height:22px; margin-top:4px; font-size:12px;"></div>
      <small style="font-size:11px; color:var(--text-muted);">–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ <code>/upload</code>, –±—ç–∫–µ–Ω–¥ –¥–µ–ª–∞–µ—Ç EDA –∏ –º–æ–¥–µ–ª—å.</small>
    </section>

    <!-- —Ü–µ–Ω—Ç—Ä: –æ—Ç—á—ë—Ç + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ + ML-–ø–æ–¥—Å–∫–∞–∑–∫–∏ + –≥—Ä–∞—Ñ–∏–∫–∏ -->
    <section class="middle-panel">
      <div class="report-box" id="reportBox">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç—á—ë—Ç ‚ú®</div>

      <div class="recs-box" id="recs"></div>

      <div class="recs-box" id="mlHints"></div>

      <div class="plots-row" id="plotsRow"></div>
    </section>

    <!-- —Å–ø—Ä–∞–≤–∞: —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—Å–∫–æ–≤ + –≤–æ–ø—Ä–æ—Å –∫ –∞–≥–µ–Ω—Ç—É -->
    <aside class="right-panel">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="runs-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏</div>
        <button style="width:auto; padding:3px 8px; font-size:11px;" onclick="loadRuns()">‚Üª</button>
      </div>
      <div id="runsList" style="min-height:60px;"></div>

      <hr style="border:0; border-top:1px solid rgba(148,163,184,0.15); margin:10px 0 8px;">

      <div class="runs-title" style="margin-bottom:6px;">–°–ø—Ä–æ—Å–∏—Ç—å DS-–∞–≥–µ–Ω—Ç–∞</div>
      <textarea id="agentQuestion" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß—Ç–æ –º–Ω–µ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏?"></textarea>
      <button id="askAgentBtn" style="margin-top:6px;" onclick="askAgent()">–°–ø—Ä–æ—Å–∏—Ç—å</button>
      <div id="agentAnswer" class="agent-answer">
        –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É run_id.
      </div>
    </aside>
  </main>

  <script>
    const reportBox   = document.getElementById('reportBox');
    const plotsRow    = document.getElementById('plotsRow');
    const statusEl    = document.getElementById('status');
    const runsList    = document.getElementById('runsList');
    const uploadBtn   = document.getElementById('uploadBtn');
    const recsBox     = document.getElementById('recs');
    const mlHintsBox  = document.getElementById('mlHints');

    const agentQuestion = document.getElementById('agentQuestion');
    const askAgentBtn   = document.getElementById('askAgentBtn');
    const agentAnswer   = document.getElementById('agentAnswer');

    let currentRunId = null;

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    async function uploadDataset() {
      const fileInput  = document.getElementById('file');
      const targetInput= document.getElementById('target');
      const file       = fileInput.files[0];

      if (!file) {
        statusEl.innerHTML = '<span class="status-err">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ CSV</span>';
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('target', targetInput.value || '');

      uploadBtn.disabled = true;
      statusEl.innerHTML = '<span style="font-size:12px; color:var(--text-muted);">–ó–∞–≥—Ä—É–∂–∞–µ–º...</span>';

      try {
        const resp = await fetch('/upload', { method: 'POST', body: formData });
        const data = await resp.json();

        if (!resp.ok) {
          statusEl.innerHTML = '<div class="status-err">–û—à–∏–±–∫–∞: ' + (data.detail?.details || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + '</div>';
          uploadBtn.disabled = false;
          return;
        }

        statusEl.innerHTML = '<span class="status-ok">–ì–æ—Ç–æ–≤–æ ‚úÖ run_id: ' + data.run_id + '</span>';
        currentRunId = data.run_id;

        renderReport(data);
        renderRecommendations(data);
        renderMLHints(data);
        renderPlots(data);
        loadRuns();

        // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–º–µ–Ω–∏–ª—Å—è
        agentAnswer.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω –Ω–æ–≤—ã–π run. –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ —ç—Ç–æ–º—É –∑–∞–ø—É—Å–∫—É.';

      } catch (err) {
        console.error(err);
        statusEl.innerHTML = '<div class="status-err">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
      } finally {
        uploadBtn.disabled = false;
      }
    }

    function renderReport(data) {
      if (data.report) {
        reportBox.textContent = data.report;
        return;
      }
      let txt = 'üìÅ ' + (data.filename || '') + '\n';
      if (data.eda?.shape) {
        txt += `üìä ${data.eda.shape[0]} —Å—Ç—Ä–æ–∫ x ${data.eda.shape[1]} –∫–æ–ª–æ–Ω–æ–∫\n`;
      }
      if (data.task?.task) {
        txt += `üß† –ó–∞–¥–∞—á–∞: ${data.task.task} ${data.task.target ? '–ø–æ ' + data.task.target : ''}\n`;
      }
      if (data.model) {
        txt += `üß™ –ú–æ–¥–µ–ª—å: ${data.model.model_type}`;
        if (data.model.accuracy != null) txt += `, acc=${data.model.accuracy.toFixed(3)}`;
        if (data.model.f1 != null)       txt += `, f1=${data.model.f1.toFixed(3)}`;
        if (data.model.roc_auc != null)  txt += `, roc_auc=${data.model.roc_auc.toFixed(3)}`;
        if (data.model.pr_auc  != null)  txt += `, pr_auc=${data.model.pr_auc.toFixed(3)}`;
        if (data.model.rmse != null)     txt += `, rmse=${data.model.rmse.toFixed(3)}`;
      }
      reportBox.textContent = txt;
    }

    function renderRecommendations(data) {
      recsBox.innerHTML = '';
      const recs = data.recommendations;
      if (!recs || !Array.isArray(recs) || recs.length === 0) {
        recsBox.innerHTML = '<span style="color:var(--text-muted);">–ü–æ–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–µ—Ç.</span>';
        return;
      }
      const h = document.createElement('h4');
      h.innerHTML = '–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:';
      const ul = document.createElement('ul');
      recs.forEach((r) => {
        const li = document.createElement('li');
        li.textContent = r;
        ul.appendChild(li);
      });
      recsBox.appendChild(h);
      recsBox.appendChild(ul);
    }

    // –≤–∞–∂–Ω–æ—Å—Ç—å —Ñ–∏—á, –∏–¥–µ–∏ —Ñ–∏—á –∏ –∫–æ–¥-–ø–æ–¥—Å–∫–∞–∑–∫–∏
    function renderMLHints(data) {
      mlHintsBox.innerHTML = '';
      const parts = [];

      // 1) –≤–∞–∂–Ω–æ—Å—Ç—å —Ñ–∏—á
      if (Array.isArray(data.feature_importance) && data.feature_importance.length > 0) {
        const top = data.feature_importance.slice(0, 5);
        let html = '<div style="margin-bottom:4px;"><strong>–¢–æ–ø —Ñ–∏—á –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏:</strong></div><ul>';
        top.forEach(fi => {
          const imp = typeof fi.importance === 'number' ? fi.importance.toFixed(3) : fi.importance;
          html += `<li>${escapeHtml(fi.feature)} ‚Äî ${escapeHtml(imp)}</li>`;
        });
        html += '</ul>';
        parts.push(html);
      }

      // 2) –∏–¥–µ–∏ —Ñ–∏—á
      if (Array.isArray(data.feature_suggestions) && data.feature_suggestions.length > 0) {
        let html = '<div style="margin-bottom:4px;"><strong>–ò–¥–µ–∏ –Ω–æ–≤—ã—Ö —Ñ–∏—á:</strong></div><ul>';
        data.feature_suggestions.slice(0, 5).forEach(s => {
          html += `<li>${escapeHtml(s)}</li>`;
        });
        html += '</ul>';
        parts.push(html);
      }

      // 3) –∫–æ–¥ / –ø—Ä–∏—ë–º—ã ‚Äî —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–µ –±–ª–æ–∫–∏
      if (Array.isArray(data.code_hints) && data.code_hints.length > 0) {
        let html = '<div style="margin-bottom:4px;"><strong>–ö–æ–¥ / –ø—Ä–∏—ë–º—ã:</strong></div><ul>';
        data.code_hints.slice(0, 5).forEach(hint => {
          if (typeof hint === 'string') {
            html += `<li>${escapeHtml(hint)}</li>`;
          } else if (hint && typeof hint === 'object') {
            const title = hint.title || hint.name || 'snippet';
            const code  = hint.code  || hint.snippet || hint.text || '';
            html += `<li>
              <details>
                <summary>${escapeHtml(title)}</summary>
                ${code ? `<pre><code>${escapeHtml(code)}</code></pre>` : ''}
              </details>
            </li>`;
          } else {
            html += `<li>${escapeHtml(String(hint))}</li>`;
          }
        });
        html += '</ul>';
        parts.push(html);
      }

      mlHintsBox.innerHTML = parts.length
        ? parts.join('<hr style="border:0; border-top:1px solid rgba(148,163,184,0.05); margin:6px 0;">')
        : '<span style="color:var(--text-muted);">–ü–æ–∫–∞ –Ω–µ—á–µ–≥–æ –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –ø–æ —Ñ–∏—á–∞–º/–∫–æ–¥—É.</span>';
    }

    function renderPlots(data) {
      plotsRow.innerHTML = '';
      if (!data.plots || !Array.isArray(data.plots) || data.plots.length === 0) return;
      data.plots.forEach(p => {
        const card = document.createElement('div');
        card.className = 'plot-card';
        const img = document.createElement('img');
        img.src = 'data:image/png;base64,' + p.image_base64;
        const title = document.createElement('div');
        title.className = 'plot-title';
        title.textContent = p.name;
        card.appendChild(img);
        card.appendChild(title);
        plotsRow.appendChild(card);
      });
    }

    async function loadRuns() {
      try {
        const resp = await fetch('/runs');
        if (!resp.ok) return;
        const arr = await resp.json();
        runsList.innerHTML = '';
        if (!arr.length) {
          runsList.innerHTML = '<div class="runs-empty">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø—É—Å–∫–æ–≤</div>';
          return;
        }
        arr.forEach(run => {
          const div = document.createElement('div');
          div.className = 'run-item' + (run.run_id === currentRunId ? ' active' : '');
          div.onclick = () => selectRun(run.run_id);
          div.innerHTML = `
            <div style="font-size:12px;">${run.filename || '(–±–µ–∑ –∏–º–µ–Ω–∏)'}</div>
            <small>${run.run_id}</small>
            <small>${run.task ? (run.task.task + (run.task.target ? ' ¬∑ ' + run.task.target : '')) : ''}</small>
          `;
          runsList.appendChild(div);
        });
      } catch (e) {
        console.warn('cannot load runs', e);
      }
    }

    async function selectRun(runId) {
      try {
        const resp = await fetch('/runs/' + runId);
        if (!resp.ok) return;
        const data = await resp.json();
        currentRunId = runId;
        renderReport(data);
        renderRecommendations(data);
        renderMLHints(data);
        renderPlots(data);

        Array.from(runsList.children).forEach(ch => {
          ch.classList.toggle('active', ch.textContent.includes(runId));
        });

        agentAnswer.textContent = '–í—ã–±—Ä–∞–Ω run ' + runId + '. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ —ç—Ç–æ–º—É –∑–∞–ø—É—Å–∫—É.';

      } catch (e) {
        console.warn('cannot load run', e);
      }
    }

    async function askAgent() {
      const q = agentQuestion.value.trim();
      if (!currentRunId) {
        agentAnswer.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∑–∞–ø—É—Å–∫ —Å–ø—Ä–∞–≤–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–π CSV.';
        return;
      }
      if (!q) {
        agentAnswer.textContent = '–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã –∞–≥–µ–Ω—Ç –º–æ–≥ –æ—Ç–≤–µ—Ç–∏—Ç—å.';
        return;
      }

      const formData = new FormData();
      formData.append('run_id', currentRunId);
      formData.append('question', q);

      askAgentBtn.disabled = true;
      agentAnswer.textContent = '–ê–≥–µ–Ω—Ç –¥—É–º–∞–µ—Ç...';

      try {
        const resp = await fetch('/ask', {
          method: 'POST',
          body: formData,
        });
        const data = await resp.json();

        if (!resp.ok) {
          agentAnswer.textContent = '–û—à–∏–±–∫–∞: ' + (data.detail?.details || data.detail || '—á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫');
          return;
        }

        agentAnswer.textContent = data.answer || '(–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –∞–≥–µ–Ω—Ç–∞)';
      } catch (e) {
        agentAnswer.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e;
      } finally {
        askAgentBtn.disabled = false;
      }
    }

    loadRuns();
  </script>
</body>
</html>
